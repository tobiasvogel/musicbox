
<fieldset>
  <legend>MIDI Out Device</legend>
  <select id=webMidiSelect></select>
</fieldset>

<fieldset>
  <legend>Select servo order</legend>
  <div>
    <input type=radio id=straightOrder name=servoOrder value=straight onchange='changeServoOrder(this);'>
    <label for="straightOrder">Straight</label>
  </div>
  <div>
    <input type=radio id=wrappedOrder name=servoOrder value=wrapped onchange='changeServoOrder(this);'>
    <label for="wrappedOrder">Wrapped</label>
  </div>
</fieldset>

<fieldset>
  <legend>Offsets</legend>
  <form>
  <table></table>
  </form>

  <button onclick='send(1);' >Send all</button>
</fieldset>

<fieldset>
  <legend>Values</legend>
  <textarea style='width:800px'></textarea><button onclick='load();'>Load</button>

<div id=sendtest></div>
</fieldset>

<fieldset>
  <legend>Source code</legend>
  <div id=cOffset style='float:left;'><pre>s8 offset[]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};</pre></div>
  <button onclick='copy_cOffset();'>Copy</button>
</fieldset>

<div id=note style='float:none;clear:both;'><small>Note: you can paste offsets directly onto this page.</small></div>

<script>
noteLookup = [ 
  48, //C3
  50, //D3
  55, //G3
  57, //A3
  59, //B3
  60,
  62,
  64,
  65, //F4
  66,
  67,
  68,
  69,
  70,
  71,
  72,
  73,
  74,
  75,
  76,
  77,
  78,
  79,
  80,
  81,
  82,
  83, //B5
  84, //C6
  86, //D6
  88
]

if (window.location.search.substring(1) == 'wrapped') {
  document.getElementById('straightOrder').checked = false;
  document.getElementById('wrappedOrder').checked = true;
} else {
  document.getElementById('straightOrder').checked = true;
  document.getElementById('wrappedOrder').checked = false;
}

s="";
for (var i=1;i<16;i++){
  s+="<tr>"
  s+="<td>"+i+"</td><td><input type=range id=num_"+i+" value=0 min=-64 max=63 oninput='calib(this,"+i+")'></td>"
if (document.getElementById('straightOrder').checked==true) {
  s+="<td>"+(i+15)+"</td><td><input type=range id=num_"+(i+15)+" value=0 min=-64 max=63 oninput='calib(this,"+(i+15)+")'></td>"
} else {
  s+="<td>"+(31-i)+"</td><td><input type=range id=num_"+(31-i)+" value=0 min=-64 max=63 oninput='calib(this,"+(31-i)+")'></td>"
}
  s+="</tr>"
}
document.querySelector('table').innerHTML=s;
tex=document.querySelector('textarea');

s=""
for (var i=1;i<=30;i++){
 s+="<button onclick='midiOut.send([0x90,"+(noteLookup[i+29])+",64])'>"+i+"</button>"
}
document.getElementById('sendtest').innerHTML=s;

function formatOffsetString(val) {
	var str = document.getElementById('cOffset');
	str.innerHTML="<pre>s8 offset[]=" +
		(val.replace("[","{")).replace("]","}") +
		";</pre>";
}
//document.querySelector('form').onchange=function(){
function calib(obj, n){
  var a=[]
  for (var i=1;i<=30;i++){
    a.push(1*document.getElementById('num_'+i).value);
  }
  tex.value=JSON.stringify(a);

  formatOffsetString(tex.value);

  midiOut.send( [ 0xAA, n-1, obj.value*1+64 ] )
}
function load(){
  var t=JSON.parse(tex.value);
  for (var i=1;i<=30;i++){
    document.getElementById('num_'+i).value=t[i-1];
  }
}
function send(i){
  midiOut.send( [ 0xAA, i-1, document.getElementById('num_'+i).value*1+64 ] )
  if (i<30)  {
    i++;
    setTimeout( function(){send(i)}, 300)
  }
}
function copy_cOffset() {
  //var copyText = document.getElementById('cOffset').innerText;
  if (document.selection) {
    var range = document.body.createTextRange();
    range.moveToElementText(document.getElementById('cOffset'));
    range.select();
  } else if (window.getSelection()) {
    var range = document.createRange();
    range.selectNode(document.getElementById('cOffset'));
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
  }
  document.execCommand('copy');
}
function paste_cOffset(clipVal) {
  let result = clipVal.match(/(?:-?[0-9]+\s?,\s?){29}(?:-?[0-9]+\s?)/);
  if (result != null) {
    tex.value=("["+result+"]");
    load();
  }
}
function changeServoOrder(obj) {
  window.location.search=obj.value;
}

midiOut=null;
function populatemidiOutSelect() {
  selectMIDI.options.length = 0;
  
  midiAccess.outputs.forEach( function(i) {
    selectMIDI.appendChild(new Option(i.name,i.id,midiOut==i,midiOut==i));
  });
  

  if (midiOut&&midiOut.state=="disconnected") selectMIDI.onchange();
}

window.addEventListener("load",function() {
  if (navigator.requestMIDIAccess) navigator.requestMIDIAccess().then( function(midi) {
       
    midiAccess = midi;
    log=document.getElementById("log");
    selectMIDI=document.getElementById("webMidiSelect");
    (midi.onstatechange = populatemidiOutSelect)();
    (selectMIDI.onchange = function() {
       if (midiOut) midiOut.onmidimessage = null;
       if (selectMIDI.options.length) midiOut = midiAccess.outputs.get(selectMIDI[selectMIDI.selectedIndex].value);
    })();
  });
});

document.addEventListener('paste', function (event) {
  var clipText = event.clipboardData.getData('Text');
  console.log(clipText);
  paste_cOffset(clipText);
});

</script>
